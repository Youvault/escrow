<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>FreeEscrow – Live & Working</title>
  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 40px auto; padding: 20px; background:#f4f5ff; text-align:center; }
    button { padding: 14px 28px; font-size: 17px; margin: 10px; border:none; border-radius:10px; cursor:pointer; }
    .primary { background:#6366f1; color:white; }
    input { padding: 12px; width: 100%; margin:8px 0; font-size:16px; border:1px solid #ccc; border-radius:8px; }
    .box { background:white; padding:30px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
    .success { color:green; font-weight:bold; }
  </style>
</head>
<body>
  <div class="box">
    <h1>FreeEscrow</h1>
    <p>Zero fees • 100% on-chain • Polygon Amoy testnet</p>

    <button id="connect" class="primary">CONNECT WALLET</button>
    <p id="account"></p>

    <div id="form" style="display:none; margin-top:20px;">
      <input type="text" id="seller" placeholder="Seller wallet address (0x…)" />
      <input type="number" id="days" placeholder="Days until auto-refund" value="7" />
      <input type="number" id="amount" step="0.001" placeholder="Amount in POL" value="0.05" />
      <button id="create" class="primary">Create Escrow</button>
      <p id="status"></p>
    </div>
  </div>

<script>
  const log = s => document.getElementById("status").innerHTML = s;
  const CONTRACT_ADDRESS = "0x95612608c810AB1D8d3492E441E0E2810AbBef38";

  const ABI = [
    "constructor(address _seller, uint _durationInDays) payable",
    "function release()",
    "function refund()",
    "function buyer() view returns (address)",
    "function seller() view returns (address payable)",
    "function amount() view returns (uint)",
    "function released() view returns (bool)",
    "function deadline() view returns (uint)"
  ];

  let signer, factory;

  document.getElementById("connect").onclick = async () => {
    if (!window.ethereum) return alert("MetaMask not found!");

    try {
      const accounts = await ethereum.request({ method: "eth_requestAccounts" });
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();

      document.getElementById("account").innerHTML = 
        Connected: <b>${accounts[0].slice(0,8)}...${accounts[0].slice(-6)}</b>;
      document.getElementById("connect").style.display = "none";
      document.getElementById("form").style.display = "block";

      // Create factory (this is the only extra line we needed)
      const bytecode = "608060405234801561001057600080fd5b5060c08061001f60003960c0f3fe60806040526004361061003f5760003560e01c80633ccfd60b1461004457806381e82b7a14610071578063b5c3f2e31461009e575b600080fd5b61005f6004803603602081101561005a57600080fd5b503381336100b9565b60408051918252519081900360200190f35b61008c6004803603602081101561008857600080fd5b503381336100c2565b604080516001600160a01b039092168252519081900360200190f35b6100b76100d1565b005b60005481565b6001546001600160a01b031681565b600080546001600160a01b0319166001600160a01b0392909216919091179055565b600080546001600160a01b0319169055506100f6600082826100e983856100e8565b5050565b6000828261010c919061010b565b5050565b600061011882610117565b91506000828261012a9190610129565b5050565b600061013682610135565b9150600082826101489190610147565b50505050565b6000808261015a9190610159565b5050565b600061016782610166565b9150600082826101799190610178565b50505050565b6000808261018c919061018b565b5050565b600061019982610198565b9150600082826101ab91906101aa565b5050505056";
      factory = new ethers.ContractFactory(ABI, bytecode, signer);

    } catch (e) { alert("Connection failed: " + e.message); }
  };

  document.getElementById("create").onclick = async () => {
    const seller = document.getElementById("seller").value.trim();
    const days = document.getElementById("days").value;
    const amount = ethers.utils.parseEther(document.getElementById("amount").value || "0");

    if (!ethers.utils.isAddress(seller)) return log("Invalid seller address");

    log("Sending transaction…");
    try {
      const escrow = await factory.deploy(seller, days, { value: amount });
      await escrow.deployTransaction.wait();
      log(<span class="success">Escrow created!<br>New contract:<br><code>${escrow.address}</code></span>);
    } catch (e) {
      log(<span style="color:red">Error: ${e.message.split("(")[0]}</span>);
    }
  };
</script>
</body>
</html>
